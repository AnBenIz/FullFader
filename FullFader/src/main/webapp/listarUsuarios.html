<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="listarUsuarios.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>

<body>
    <header>
        <div class="logo">
            <img src="images/fotos/pexels-dominika-roseclay-1021876.jpg" alt="Logo">
        </div>

        <div id="userSection">
            <!-- Aquí se mostrará el nombre del usuario -->
            <span id="nombreUsuario"></span>
            <button id="logoutButton" style="display: none;" onclick="cerrarSesion()">
                <img id="logoutIcon" src="images/iconos/icons8-cerrar-sesión-96.png" alt="Icono Logout">
            </button>
            <a id="loginLink" href="login.html" class="login" style="display: none;">
                <img src="images/iconos/icons8-cuenta-de-prueba-96.png" alt="Icono Login">
            </a>       
        </div>

    </header>

    <div class="contenedorMenu">
        <a href="index.html" class="logoMenu">FullFader</a>

        <input type="checkbox" id="check" />
        <label for="check" class="icons">
            <i class="bx bx-menu" id="menu-icon"></i>
            <i class="bx bx-x" id="close-icon"></i>
        </label>
        <nav class="navbar">
            <a class="inicio" href="index.html" style="--i:1;">INICIO</a>
            <a class="altas" href="altas.html" style="--i:1;">SUBIR TRACK</a>
            <a class="listarTracks" href="listarTracks.html" style="--i:3;">TRACKS</a>
            <a class="listarUsuarios" href="listarUsuarios.html" style="--i:4;">USUARIOS</a>
            <a class="login" href="login.html" style="--i:6;">LOGIN</a>
            <a class="registro" href="registro.html" style="--i:7;">REGISTRO</a>
        </nav>
    </div>
    </div>

    <main>
        <h1>Lista De Usuarios</h1>
        </div>
        <table id="listado">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Contraseña</th>
                    <th>Rol</th>
                    <th>Editar</th>
                    <th>Borrar</th>
                </tr>
            </thead>
            <tbody>
                <!-- Aquí se llenarán las filas de la tabla con datos dinámicamente -->
            </tbody>
        </table>
    </main>


    <footer>
        <div class="redes_sociales">
            <a href="#"><img src="images/iconos/icons8-facebook-96.png" alt="Facebook"></a>
            <a href="#"><img src="images/iconos/icons8-xbox-x-96.png" alt="Twitter"></a>
        </div>
        <p>Información del autor - Copyright - Otros detalles</p>
    </footer>

    <script>
        function obtenerNombreUsuario() {
        fetch('Verificar')
        .then(response => response.text())
        .then(data => {
            const nombreUsuario = document.getElementById('nombreUsuario');
            const logoutButton = document.getElementById('logoutButton');
            const logoutIcon = document.getElementById('logoutIcon');
            const loginLink = document.getElementById('loginLink');

            if (data) {
                // Si hay un nombre de usuario, mostrarlo y el botón de logout, ocultar el enlace de login
                nombreUsuario.innerText = data;
                logoutButton.style.display = 'inline-block';
                logoutIcon.style.display = 'inline-block';
                loginLink.style.display = 'none';
                } else {
                // Si no hay nombre de usuario, mostrar el enlace de login, ocultar el botón y el icono de logout
                nombreUsuario.innerText = '';
                logoutButton.style.display = 'none';
                logoutIcon.style.display = 'none';
                loginLink.style.display = 'inline-block';
                }
            });
        }

        // Función para cerrar la sesión
        function cerrarSesion() {
            fetch('FullFader?logout=true') // Agregar el parámetro de logout
                .then(response => {
                    if (response.ok) {
                        // Si la sesión se cerró correctamente, redirigir al usuario a la página de inicio de sesión
                        window.location.href = 'index.html';
                    } else {
                        // Manejar el caso de error si es necesario
                        console.error('Error al cerrar sesión:', response.status);
                    }
                })
                .catch(error => console.error('Error al cerrar sesión:', error));
        }
        
        function llamada() {
            console.log("entra en llamada")
            let xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            const resultados = JSON.parse(xhr.responseText);
                            llenarTabla(resultados);
                        } catch (e) {
                            console.error("Error al parsear los datos JSON");
                        }
                    }
                }

            };
            xhr.open("GET", "Usuarios", false);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send();
        }

        function llenarTabla(datos) {
            const tbody = document.querySelector("#listado tbody");
            tbody.innerHTML = '';  // Limpiar el cuerpo de la tabla primero
            console.log(datos);
            datos.forEach(dato => {
                const fila = document.createElement("tr");
                fila.innerHTML = `
                <td>${dato.nombre}</td>
                <td>${dato.correoElectronico}</td>
                <td>#####</td>
                <td>${dato.rol}</td>
                <td>
                    <a href="modificarUsuarios.html?idUsuarios=${dato.idUsuario}">
                    <img class="iconoEditar" src="images/iconos/icons8-editar-96.png">
                </a>                
                </td>
                <td>
                    <a href="javascript:borrar(${dato.idUsuario})">
                        <img class="iconoBorrar" src="images/iconos/icons8-eliminar-96.png">
                    </a>
                </td>`;
                tbody.appendChild(fila);
            });
        }

        function borrar(idUsuarios) {
            if (confirm("Seguro que quieres borrar")) {
                fetch('Usuarios?idUsuarios=' + idUsuarios, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (response.ok) {
                            // Si la eliminación fue exitosa, recargar la página
                            window.location.reload();
                        } else {
                            // Si la eliminación falló, mostrar un mensaje de error
                            console.error('Error al borrar usuario:', response.status);
                        }
                    })
                    .catch(error => console.error('Error al borrar usuario:', error));
            } else {
                // No se realiza ninguna acción si el usuario cancela la eliminación
            }
        }

        // Función para cargar la lista de tracks y obtener el nombre de usuario al mismo tiempo
        function cargarPagina() {
            obtenerNombreUsuario(); // Obtener nombre de usuario
            llamada(); // Cargar lista de tracks
        }
        // Llama a la función al cargar la página para obtener el nombre del usuario si está conectado y cargar la lista de tracks
        window.onload = cargarPagina;

    </script>

</body>

</html>